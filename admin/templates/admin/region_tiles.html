{% extends "layout-base.html" %}

{% block title %}{{ region_info.display_name }} Tiles - Tile Browser{% endblock %}

{% block content %}

<div class="dashboard">
    <header class="page-header">
        <h1>{{ region_info.display_name }} Tiles</h1>
        <p class="page-description">Browse and view individual tiles for this region</p>
    </header>
    
    <section class="tiles-actions-header">
        <div class="actions-grid">
            <a href="{{ url_for('tiles.index') }}" class="btn btn-secondary">← Back to Tiles</a>
            <a href="{{ url_for('regions.region_detail', region_name=region_name) }}" class="btn btn-secondary">Region Details</a>
        </div>
    </section>
    
    {% if region_info %}
    <section class="region-summary">
        <div class="summary-stats">
            <div class="stat-item">
                <strong>{{ region_info.tile_count }}</strong>
                <span>Tiles</span>
            </div>
            <div class="stat-item">
                <strong>{{ region_info.total_size_mb }}MB</strong>
                <span>Total Size</span>
            </div>
            <div class="stat-item">
                <strong>{{ "%.1f"|format(region_info.total_size_kb / region_info.tile_count) }}KB</strong>
                <span>Avg per Tile</span>
            </div>
            {% if region_info.metadata and region_info.metadata.bounds %}
            <div class="stat-item">
                <strong>{{ "%.3f"|format(region_info.metadata.bounds.north - region_info.metadata.bounds.south) }}°</strong>
                <span>Latitude Range</span>
            </div>
            <div class="stat-item">
                <strong>{{ "%.3f"|format(region_info.metadata.bounds.east - region_info.metadata.bounds.west) }}°</strong>
                <span>Longitude Range</span>
            </div>
            {% endif %}
        </div>
    </section>
    {% endif %}
    
    {% if tiles %}
    <section class="tiles-grid-section">
        <div class="tiles-controls">
            <div class="view-controls">
                <button onclick="setView('grid')" class="btn btn-sm btn-secondary" id="grid-btn">Grid View</button>
                <button onclick="setView('list')" class="btn btn-sm btn-outline" id="list-btn">List View</button>
            </div>
            <div class="sort-controls">
                <label for="sort-select">Sort by:</label>
                <select id="sort-select" onchange="sortTiles()">
                    <option value="name">Coordinates</option>
                    <option value="size">File Size</option>
                    <option value="lat">Latitude</option>
                    <option value="lng">Longitude</option>
                </select>
            </div>
        </div>
        
        <div id="tiles-container" class="tiles-grid">
            {% for tile in tiles %}
            <div class="tile-card" 
                 data-name="{{ tile.display_name }}" 
                 data-size="{{ tile.size_kb }}" 
                 data-lat="{{ tile.lat }}" 
                 data-lng="{{ tile.lng }}">
                <div class="tile-preview">
                    <iframe src="{{ tile.url }}" 
                            width="150" height="150" 
                            frameborder="0"
                            title="Tile preview for {{ tile.display_name }}"></iframe>
                </div>
                <div class="tile-info">
                    <h4 class="tile-title">{{ tile.display_name }}</h4>
                    <p class="tile-coords">{{ "%.3f"|format(tile.lat) }}, {{ "%.3f"|format(tile.lng) }}</p>
                    <p class="tile-size">{{ tile.size_kb }}KB</p>
                </div>
                <div class="tile-actions">
                    <a href="{{ tile.url }}" class="btn btn-sm btn-primary" target="_blank">View Full</a>
                    <a href="{{ tile.url }}/raw" class="btn btn-sm btn-outline" download>Download</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% elif message %}
    <div class="empty-state">
        <h3>{{ message }}</h3>
        <p>This region exists but contains no tiles.</p>
        <a href="{{ url_for('regions.region_detail', region_name=region_name) }}" class="btn btn-primary">Region Details</a>
    </div>
    {% else %}
    <div class="empty-state">
        <h3>No Tiles Found</h3>
        <p>Unable to load tiles for this region.</p>
        <a href="{{ url_for('tiles.index') }}" class="btn btn-secondary">Back to Tiles</a>
    </div>
    {% endif %}
</div>

<script>
let currentView = 'grid';
let currentSort = 'name';

function setView(viewType) {
    currentView = viewType;
    const container = document.getElementById('tiles-container');
    const gridBtn = document.getElementById('grid-btn');
    const listBtn = document.getElementById('list-btn');
    
    if (viewType === 'grid') {
        container.className = 'tiles-grid';
        gridBtn.className = 'btn btn-sm btn-secondary';
        listBtn.className = 'btn btn-sm btn-outline';
    } else {
        container.className = 'tiles-list';
        gridBtn.className = 'btn btn-sm btn-outline';
        listBtn.className = 'btn btn-sm btn-secondary';
    }
}

function sortTiles() {
    const select = document.getElementById('sort-select');
    currentSort = select.value;
    
    const container = document.getElementById('tiles-container');
    const cards = Array.from(container.children);
    
    cards.sort((a, b) => {
        let aVal, bVal;
        
        switch(currentSort) {
            case 'size':
                aVal = parseFloat(a.dataset.size);
                bVal = parseFloat(b.dataset.size);
                return bVal - aVal; // Descending
            case 'lat':
                aVal = parseFloat(a.dataset.lat);
                bVal = parseFloat(b.dataset.lat);
                return bVal - aVal; // North to South
            case 'lng':
                aVal = parseFloat(a.dataset.lng);
                bVal = parseFloat(b.dataset.lng);
                return aVal - bVal; // West to East
            default: // name
                aVal = a.dataset.name;
                bVal = b.dataset.name;
                return aVal.localeCompare(bVal);
        }
    });
    
    // Re-append in sorted order
    cards.forEach(card => container.appendChild(card));
}
</script>

<style>
.tiles-actions-header {
    margin-bottom: 2rem;
}

.tiles-actions-header .actions-grid {
    display: flex;
    gap: 1rem;
}

.region-summary {
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
}

.stat-item {
    text-align: center;
    padding: 1rem;
    background: var(--background-color);
    border-radius: 4px;
}

.stat-item strong {
    display: block;
    font-size: 1.5rem;
    color: var(--primary-color);
    margin-bottom: 0.25rem;
}

.stat-item span {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.tiles-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding: 1rem;
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
}

.view-controls, .sort-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sort-controls label {
    font-weight: 500;
    color: var(--text-primary);
}

.sort-controls select {
    padding: 0.25rem 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--surface-color);
}

.tiles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
}

.tiles-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.tile-card {
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    transition: box-shadow 0.2s;
}

.tile-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.tiles-list .tile-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
}

.tile-preview {
    text-align: center;
    margin-bottom: 1rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    overflow: hidden;
}

.tiles-list .tile-preview {
    margin-bottom: 0;
    flex-shrink: 0;
}

.tile-preview iframe {
    display: block;
    background: white;
}

.tiles-list .tile-preview iframe {
    width: 80px;
    height: 80px;
}

.tile-info {
    margin-bottom: 1rem;
}

.tiles-list .tile-info {
    flex-grow: 1;
    margin-bottom: 0;
}

.tile-title {
    margin: 0 0 0.25rem 0;
    font-size: 1rem;
    color: var(--text-primary);
}

.tile-coords {
    margin: 0 0 0.25rem 0;
    font-family: monospace;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.tile-size {
    margin: 0;
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.tile-actions {
    display: flex;
    gap: 0.5rem;
}

.tiles-list .tile-actions {
    flex-shrink: 0;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: white;
}

@media (max-width: 768px) {
    .tiles-controls {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .view-controls, .sort-controls {
        justify-content: center;
    }
    
    .tiles-grid {
        grid-template-columns: 1fr;
    }
    
    .tiles-list .tile-card {
        flex-direction: column;
        text-align: center;
    }
    
    .tiles-list .tile-preview {
        margin-bottom: 1rem;
    }
    
    .tiles-list .tile-info {
        margin-bottom: 1rem;
    }
}
</style>

{% endblock %}