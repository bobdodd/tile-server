{% extends "layout-base.html" %}

{% block title %}Admin Dashboard - Tile Generation Server{% endblock %}

{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-messages">
      {% for category, message in messages %}
        <div class="flash-message flash-{{ category }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}
<div class="dashboard">
    <header class="page-header">
        <h1>Tile Generation Dashboard</h1>
        <p class="page-description">Overview of tile regions and generation status</p>
    </header>
    
    <section class="stats-grid" aria-labelledby="stats-heading">
        <h2 id="stats-heading" class="visually-hidden">Server Statistics</h2>
        
        <div class="stat-card">
            <h3>Total Regions</h3>
            <p class="stat-number">{{ stats.total_regions }}</p>
            <p class="stat-label">Active regions</p>
        </div>
        
        <div class="stat-card">
            <h3>Total Tiles</h3>
            <p class="stat-number">{{ stats.total_tiles }}</p>
            <p class="stat-label">Generated tiles</p>
        </div>
        
        <div class="stat-card">
            <h3>Storage Used</h3>
            <p class="stat-number">{{ "%.1f"|format(stats.total_size_mb) }}MB</p>
            <p class="stat-label">Local disk usage</p>
        </div>
        
        <div class="stat-card">
            <h3>Server Tiles</h3>
            <p class="stat-number">{{ stats.server_tiles }}</p>
            {% if stats.siteground_configured %}
                <p class="stat-label">On SiteGround server</p>
            {% else %}
                <p class="stat-label">SiteGround not configured</p>
            {% endif %}
        </div>
    </section>
    
    <section class="regions-overview" aria-labelledby="regions-heading">
        <h2 id="regions-heading">Regional Coverage</h2>
        
        {% if stats.regions %}
        <div class="regions-grid">
            {% for region in stats.regions %}
            <div class="region-card">
                <h3>{{ region.name }}</h3>
                <div class="region-stats">
                    <p><strong>Local:</strong> {{ region.local_tile_count }} tiles</p>
                    <p><strong>Server:</strong> {{ region.server_tile_count }} tiles</p>
                    {% if region.size_mb > 0 %}
                        <p><strong>Size:</strong> {{ "%.1f"|format(region.size_mb) }}MB</p>
                    {% endif %}
                    <p class="status status-{{ region.status }}">
                        {% if region.status == 'synced' %}‚úÖ Synced
                        {% elif region.status == 'local_only' %}üì± Local Only
                        {% elif region.status == 'server_only' %}‚òÅÔ∏è Server Only
                        {% elif region.status == 'partial' %}‚ö†Ô∏è Partial Sync
                        {% else %}{{ region.status|title }}
                        {% endif %}
                    </p>
                </div>
                <div class="region-actions">
                    {% if region.local_tile_count > 0 %}
                        <a href="/tiles/regions/{{ region.region_id }}/" class="btn btn-secondary">View Local</a>
                    {% endif %}
                    {% if region.server_tile_count > 0 %}
                        <a href="https://bobd77.sg-host.com/tiles/" class="btn btn-secondary" target="_blank">View Server (Flat)</a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <h3>No Regions Found</h3>
            <p>Create your first region to start generating tiles.</p>
            <a href="/admin/regions/create" class="btn btn-primary">Create Region</a>
        </div>
        {% endif %}
    </section>
    
    <section class="siteground-upload" aria-labelledby="upload-heading">
        <h2 id="upload-heading">SiteGround Upload</h2>
        
        {% if stats.siteground_configured %}
        <div class="upload-controls">
            <p class="status-message success">‚úÖ SiteGround FTP configured</p>
            <div class="upload-actions">
                <form method="POST" action="/admin/sync-all" style="display: inline;">
                    <button type="submit" class="btn btn-primary">Sync All Regions</button>
                </form>
                <a href="/admin/test-connection" class="btn btn-secondary" id="test-connection">Test Connection</a>
            </div>
        </div>
        
        {% if stats.regions %}
        <div class="region-upload-grid">
            {% for region in stats.regions %}
            {% if region.local_tile_count > 0 %}
            <div class="region-upload-card">
                <h4>{{ region.name }}</h4>
                <p>{{ region.local_tile_count }} local tiles 
                   {% if region.size_mb > 0 %}({{ "%.1f"|format(region.size_mb) }}MB){% endif %}</p>
                <p class="upload-status">
                    {% if region.status == 'synced' %}‚úÖ Up to date
                    {% elif region.status == 'local_only' %}‚¨ÜÔ∏è Needs upload
                    {% elif region.status == 'partial' %}‚ö†Ô∏è Partial sync
                    {% endif %}
                </p>
                <form method="POST" action="/admin/upload/{{ region.region_id }}">
                    <button type="submit" class="btn btn-sm btn-outline">
                        {% if region.status == 'synced' %}Re-upload
                        {% else %}Upload Region
                        {% endif %}
                    </button>
                </form>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}
        
        {% else %}
        <div class="config-warning">
            <p class="status-message warning">‚ö†Ô∏è SiteGround not configured</p>
            <p>Create a <code>.env</code> file with your SiteGround FTP credentials:</p>
            <pre>SITEGROUND_HOST=yourdomain.com
SITEGROUND_USERNAME=your-ftp-username
SITEGROUND_PASSWORD=your-ftp-password</pre>
        </div>
        {% endif %}
    </section>
    
    <section class="quick-actions" aria-labelledby="actions-heading">
        <h2 id="actions-heading">Quick Actions</h2>
        <div class="actions-grid">
            <a href="/api/regions" class="action-card">
                <h3>API Documentation</h3>
                <p>View available API endpoints and regional data</p>
            </a>
            <a href="/tiles/regions/" class="action-card">
                <h3>Browse Local Tiles</h3>
                <p>View locally generated tile files</p>
            </a>
            <div class="action-card" onclick="window.open('https://bobd77.sg-host.com/tiles/', '_blank')">
                <h3>View Live Tiles</h3>
                <p>See tiles served from SiteGround (flat structure)</p>
            </div>
            <div class="action-card">
                <h3>Generate New Tiles</h3>
                <p>Coming soon - tile generation interface</p>
            </div>
        </div>
    </section>
</div>
{% endblock %}